-- VHDL Entity hsio.dio_ibeos_st.symbol
--
-- Created by Matt Warren 2014
--
-- Generated by Mentor Graphics' HDL Designer(TM) 2013.1 (Build 6)
--

library ieee;
use ieee.std_logic_1164.all;
use ieee.std_logic_arith.all;
use ieee.std_logic_unsigned.all;


library utils;
use utils.pkg_types.all;

library hsio;
use hsio.pkg_hsio_globals.all;

entity dio_ibeos_st is
   generic( 
      LINK_ID_MIN : integer := 0
   );
   port( 
      clk                : in     std_logic;
      com_i              : in     std_logic;
      dat_ni             : in     std_logic_vector (23 downto 0);  -- ID0_1 (J33.11) ID0_1_BUF (J26.A4)
      dat_pi             : in     std_logic_vector (23 downto 0);  -- ID0_1 (J33.11) ID0_1_BUF (J26.A4)
      --idelay_ce_o   : out    std_logic_vector (71 downto 0);
      --idelay_inc_o  : out    std_logic;
      --idelay_zero_o : out    std_logic_vector (71 downto 0);
      idelay_ctl_i       : in     t_idelay_ctl;
      l1r_i              : in     std_logic;
      noise_i            : in     std_ulogic;
      rawcom_i           : in     std_logic;
      -- registers
      reg                : in     t_reg_bus;
      rst                : in     std_logic;
      strobe40_i         : in     std_logic;
      bco_no             : out    std_logic;                       -- HARDRESETB (J32.6/J33.14) HRSTB (J26.B3)
      bco_po             : out    std_logic;                       -- HARDRESET (J32.5/J33.13) HRST (J26.A3)
      com_no             : out    std_logic;                       -- COMMANB (J32.6/J33.2) COM_INB (J26.D3)
      com_po             : out    std_logic;                       -- COMMAND (J32.5/J33.1) COM_IN (J26.C3)
      --dbg_sig_o  : out    std_logic;
      dbg_com_o          : out    std_logic;
      --dbg_sig_o  : out    std_logic;
      dbg_l1r_o          : out    std_logic;
      --dbg_sig_o  : out    std_logic;
      dbg_noise_o        : out    std_logic;
      l1r_no             : out    std_logic;                       -- LONEB (J32.10/J33.6) LONE_INB (J26.F3)
      l1r_po             : out    std_logic;                       -- LONE (J32.9/J33.5) LONE_IN (J26.E3)
      noise_no           : out    std_logic;                       -- COMMANB (J32.6/J33.2) COM_INB (J26.D3)
      noise_po           : out    std_logic;                       -- COMMAND (J32.5/J33.1) COM_IN (J26.C3)
      rx_link_idelayed_o : out    std_logic_vector (23 downto 0);
      rx_strm_o          : out    std_logic_vector (47 downto 0)
   );

-- Declarations

end dio_ibeos_st ;

-- VHDL from Block Diagram 
-- Generated by Mentor Graphics HDL Designer(TM) 2013.1 (Build 6) 
--
-- hsio.dio_ibeos_st.struct
--
-- Created by Matt Warren 2014
--

library ieee;
use ieee.std_logic_1164.all;
use ieee.std_logic_arith.all;
use ieee.std_logic_unsigned.all;
library utils;
use utils.pkg_types.all;
library hsio;
use hsio.pkg_hsio_globals.all;

library unisim;
use unisim.VCOMPONENTS.all;


architecture struct of dio_ibeos_st is

   -- Architecture declarations

   -- Internal signal declarations
   signal HI          : std_logic;
   signal LO          : std_logic;
   signal bco         : std_logic;
   signal bco_ddr     : std_logic;
   signal bco_ddr_n   : std_logic;
   signal bco_en      : std_logic;
   signal com         : std_logic;
   signal com_in      : std_logic;
   signal l1r         : std_logic;
   signal l1r_in      : std_logic;
   signal loopdata    : std_logic_vector(47 downto 0);
   signal noise       : std_ulogic;
   signal noise_in    : std_ulogic;
   signal rawcom_in   : std_logic;
   signal rawout_en_n : std_logic;
   signal rx_link     : std_logic_vector(23 downto 0);


attribute KEEP : string;
--attribute KEEP of reg_com_enable_i : signal is "true";
--attribute KEEP of reg_control_i : signal is "true";

   -- Component Declarations
   component four_phase
   port (
      sig_i      : in     std_logic ;
      sig_o      : out    std_logic ;
      --dbg_sig_o  : out    std_logic;
      dbg_sig0_o : out    std_logic ;
      --    sig_0_o   : out std_logic;
      --    sig_90_o  : out std_logic;
      --    sig_180_o : out std_logic;
      --    sig_270_o : out std_logic;
      sel_i      : in     std_logic_vector (1 downto 0);
      invert_i   : in     std_logic ;
      com_i      : in     std_logic ;
      com_en     : in     std_logic ;
      rst        : in     std_logic ;
      clk        : in     std_logic 
   );
   end component;
   component idelay_block
   generic (
      LINK_ID : integer := 0
   );
   port (
      clk                    : in     std_logic ;
      ddrdata_i              : in     std_logic ;
      --idelay_ce_o   : out    std_logic_vector (71 downto 0);
      --idelay_inc_o  : out    std_logic;
      --idelay_zero_o : out    std_logic_vector (71 downto 0);
      idelay_ctl_i           : in     t_idelay_ctl ;
      loopdata0_i            : in     std_logic ;
      loopdata1_i            : in     std_logic ;
      rst                    : in     std_logic ;
      dbg_ddrdata_idelayed_o : out    std_logic ;
      stream0_o              : out    std_logic ;
      stream1_o              : out    std_logic 
   );
   end component;
   component IBUFDS
   generic (
      CAPACITANCE      : string  := "DONT_CARE";
      DIFF_TERM        : boolean := FALSE;
      DQS_BIAS         : string  := "FALSE";
      IBUF_DELAY_VALUE : string  := "0";
      IBUF_LOW_PWR     : boolean := TRUE;
      IFD_DELAY_VALUE  : string  := "AUTO";
      IOSTANDARD       : string  := "DEFAULT"
   );
   port (
      I  : in     std_ulogic;
      IB : in     std_ulogic;
      O  : out    std_ulogic
   );
   end component;
   component OBUFDS
   generic (
      CAPACITANCE : string := "DONT_CARE";
      IOSTANDARD  : string := "DEFAULT";
      SLEW        : string := "SLOW"
   );
   port (
      I  : in     std_ulogic;
      O  : out    std_ulogic;
      OB : out    std_ulogic
   );
   end component;
   component ODDR
   generic (
      DDR_CLK_EDGE : string := "OPPOSITE_EDGE";
      INIT         : bit    := '0';
      SRTYPE       : string := "SYNC"
   );
   port (
      C  : in     std_ulogic;
      CE : in     std_ulogic;
      D1 : in     std_ulogic;
      D2 : in     std_ulogic;
      R  : in     std_ulogic;
      S  : in     std_ulogic;
      Q  : out    std_ulogic
   );
   end component;
   component m_power
   port (
      hi : out    std_logic ;
      lo : out    std_logic 
   );
   end component;


begin
   -- Architecture concurrent statements
   -- HDL Embedded Text Block 2 eb2
   rawout_en_n <= not reg(R_CONTROL1)(CTL_RAWOUT_EN);

   -- HDL Embedded Text Block 3 eb3
   -- eb1 1
   bco_en <= reg(R_COM_ENA)(B_BCO_EN);
   -- for compat reasons bco is inverted
   bco_ddr <= strobe40_i when (reg(R_COM_ENA)(B_BCO_INV) = '1') else
               not strobe40_i;
   


   -- ModuleWare code(v1.12) for instance 'U_0' of 'and'
   com_in <= rawout_en_n and com_i;

   -- ModuleWare code(v1.12) for instance 'U_2' of 'and'
   l1r_in <= rawout_en_n and l1r_i;

   -- ModuleWare code(v1.12) for instance 'U_3' of 'and'
   noise_in <= rawout_en_n and noise_i;

   -- ModuleWare code(v1.12) for instance 'U_4' of 'and'
   rawcom_in <= rawout_en_n and rawcom_i;

   -- ModuleWare code(v1.12) for instance 'U_1' of 'inv'
   bco_ddr_n <= not(bco_ddr);

   -- Instance port mappings.
   Ufourphase9 : four_phase
      port map (
         sig_i      => noise_in,
         sig_o      => noise,
         dbg_sig0_o => dbg_noise_o,
         sel_i      => reg(R_COM_ENA)(15 DOWNTO 14),
         invert_i   => LO,
         com_i      => rawcom_in,
         com_en     => reg(R_CONTROL)(CTL_COM_NOISE_EN),
         rst        => rst,
         clk        => clk
      );
   Ufourphase10 : four_phase
      port map (
         sig_i      => l1r_in,
         sig_o      => l1r,
         dbg_sig0_o => dbg_l1r_o,
         sel_i      => reg(R_COM_ENA)(15 DOWNTO 14),
         invert_i   => LO,
         com_i      => rawcom_in,
         com_en     => reg(R_COM_ENA)(B_COM_ST_L1R),
         rst        => rst,
         clk        => clk
      );
   Ufourphase11 : four_phase
      port map (
         sig_i      => com_in,
         sig_o      => com,
         dbg_sig0_o => dbg_com_o,
         sel_i      => reg(R_COM_ENA)(15 DOWNTO 14),
         invert_i   => LO,
         com_i      => rawcom_in,
         com_en     => reg(R_COM_ENA)(B_ST_COM_EN),
         rst        => rst,
         clk        => clk
      );
   Uob0 : OBUFDS
      generic map (
         CAPACITANCE => "DONT_CARE",
         IOSTANDARD  => "LVDS_25"
      )
      port map (
         O  => com_po,
         OB => com_no,
         I  => com
      );
   Uob1 : OBUFDS
      generic map (
         CAPACITANCE => "DONT_CARE",
         IOSTANDARD  => "LVDS_25"
      )
      port map (
         O  => bco_po,
         OB => bco_no,
         I  => bco
      );
   Uob2 : OBUFDS
      generic map (
         CAPACITANCE => "DONT_CARE",
         IOSTANDARD  => "LVDS_25"
      )
      port map (
         O  => l1r_po,
         OB => l1r_no,
         I  => l1r
      );
   Uob3 : OBUFDS
      generic map (
         CAPACITANCE => "DONT_CARE",
         IOSTANDARD  => "LVDS_25"
      )
      port map (
         O  => noise_po,
         OB => noise_no,
         I  => noise
      );
   Uoddrbcopp5 : ODDR
      generic map (
         DDR_CLK_EDGE => "SAME_EDGE",
         INIT         => '0',
         SRTYPE       => "SYNC"
      )
      port map (
         Q  => bco,
         C  => clk,
         CE => bco_en,
         D1 => bco_ddr,
         D2 => bco_ddr_n,
         R  => rst,
         S  => LO
      );
   Umpower : m_power
      port map (
         hi => HI,
         lo => LO
      );

   gdo1: FOR i IN 0 TO 23 GENERATE
      Uibd4 : IBUFDS
         generic map (
            CAPACITANCE      => "DONT_CARE",
            DIFF_TERM        => TRUE,
            IBUF_DELAY_VALUE => "0",
            IFD_DELAY_VALUE  => "AUTO",
            IOSTANDARD       => "LVDS_25"
         )
         port map (
            O  => rx_link(i),
            I  => dat_pi(i),
            IB => dat_ni(i)
         );
      Uidelayblk : idelay_block
         generic map (
            LINK_ID => i+LINK_ID_MIN
         )
         port map (
            clk                    => clk,
            ddrdata_i              => rx_link(i),
            idelay_ctl_i           => idelay_ctl_i,
            loopdata0_i            => LO,
            loopdata1_i            => LO,
            rst                    => rst,
            dbg_ddrdata_idelayed_o => rx_link_idelayed_o(i),
            stream0_o              => rx_strm_o(i*2),
            stream1_o              => rx_strm_o(i*2+1)
         );
   end generate gdo1;

end struct;
